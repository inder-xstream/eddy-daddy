generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                     String         @id @default(uuid()) @db.Uuid
  email                  String         @unique
  username               String         @unique
  avatarUrl              String?        @map("avatar_url")
  isVerified             Boolean        @default(false) @map("is_verified")
  role                   UserRole       @default(USER)
  authProvider           String?        @map("auth_provider")
  createdAt              DateTime       @default(now()) @map("created_at")
  updatedAt              DateTime       @updatedAt @map("updated_at")
  password               String?
  isPremium              Boolean        @default(false) @map("is_premium")
  stripeCurrentPeriodEnd DateTime?      @map("stripe_current_period_end")
  stripeCustomerId       String?        @unique @map("stripe_customer_id")
  stripePriceId          String?        @map("stripe_price_id")
  stripeSubscriptionId   String?        @unique @map("stripe_subscription_id")
  accounts               Account[]
  commentLikes           CommentLike[]
  comments               Comment[]
  likes                  Like[]
  model                  Model?
  notifications          Notification[] @relation("NotificationRecipient")
  reviewedReports        Report[]       @relation("ReviewedReports")
  reports                Report[]       @relation("ReportedBy")
  sessions               Session[]
  subscribers            Subscription[] @relation("Creator")
  subscriptions          Subscription[] @relation("Subscriber")
  videoViews             VideoView[]    @relation("UserViews")
  videos                 Video[]
  watchHistory           WatchHistory[]

  @@map("users")
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model Video {
  id              String            @id @default(uuid()) @db.Uuid
  bunnyVideoId    String            @unique @map("bunny_video_id")
  userId          String            @map("user_id") @db.Uuid
  title           String            @db.VarChar(200)
  description     String?
  duration        Int?
  thumbnailUrl    String?           @map("thumbnail_url")
  hlsUrl          String?           @map("hls_url")
  status          VideoStatus       @default(PENDING)
  failureReason   String?           @map("failure_reason")
  viewsCount      Int               @default(0) @map("views_count")
  likesCount      Int               @default(0) @map("likes_count")
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  publishedAt     DateTime?         @map("published_at")
  orientation     VideoOrientation?
  previewUrl      String?           @map("preview_url")
  resolutions     String[]          @default([])
  isPremium       Boolean           @default(false) @map("is_premium")
  comments        Comment[]
  likes           Like[]
  reports         Report[]
  videoCategories VideoCategory[]
  videoModels     VideoModel[]
  videoTags       VideoTag[]
  videoViews      VideoView[]
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  watchHistory    WatchHistory[]

  @@index([title(ops: raw("gin_trgm_ops"))], map: "title_search_idx", type: Gin)
  @@index([description(ops: raw("gin_trgm_ops"))], map: "description_search_idx", type: Gin)
  @@index([createdAt(sort: Desc)])
  @@index([viewsCount(sort: Desc)])
  @@index([userId])
  @@index([status])
  @@map("videos")
}

model Like {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  videoId   String   @map("video_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  video     Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@index([videoId])
  @@map("likes")
}

model Comment {
  id           String        @id @default(uuid()) @db.Uuid
  content      String
  userId       String        @map("user_id") @db.Uuid
  videoId      String        @map("video_id") @db.Uuid
  parentId     String?       @map("parent_id") @db.Uuid
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  likesCount   Int           @default(0) @map("likes_count")
  commentLikes CommentLike[]
  parent       Comment?      @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies      Comment[]     @relation("CommentReplies")
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  video        Video         @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId, createdAt])
  @@index([userId])
  @@index([parentId])
  @@map("comments")
}

model CommentLike {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  commentId String   @map("comment_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId])
  @@index([commentId])
  @@map("comment_likes")
}

model VideoView {
  id        String   @id @default(uuid()) @db.Uuid
  videoId   String   @map("video_id") @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  ipHash    String   @map("ip_hash") @db.VarChar(64)
  userAgent String?  @map("user_agent")
  country   String?  @db.VarChar(2)
  viewedAt  DateTime @default(now()) @map("viewed_at")
  user      User?    @relation("UserViews", fields: [userId], references: [id])
  video     Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([videoId, userId, ipHash])
  @@index([videoId, viewedAt])
  @@index([viewedAt(sort: Desc)])
  @@map("video_views")
}

model WatchHistory {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  videoId         String   @map("video_id") @db.Uuid
  watchedAt       DateTime @default(now()) @map("watched_at")
  progressSeconds Int      @default(0) @map("progress_seconds")
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  video           Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@index([userId, watchedAt(sort: Desc)])
  @@index([videoId])
  @@map("watch_history")
}

model Report {
  id          String       @id @default(uuid()) @db.Uuid
  videoId     String       @map("video_id") @db.Uuid
  userId      String?      @map("user_id") @db.Uuid
  reason      String       @db.VarChar(100)
  description String?
  status      ReportStatus @default(PENDING)
  reviewedBy  String?      @map("reviewed_by") @db.Uuid
  reviewedAt  DateTime?    @map("reviewed_at")
  adminNotes  String?      @map("admin_notes")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  reviewer    User?        @relation("ReviewedReports", fields: [reviewedBy], references: [id])
  user        User?        @relation("ReportedBy", fields: [userId], references: [id])
  video       Video        @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("reports")
}

model Tag {
  id        String     @id @default(uuid()) @db.Uuid
  name      String     @unique @db.VarChar(50)
  slug      String     @unique @db.VarChar(50)
  createdAt DateTime   @default(now()) @map("created_at")
  videos    VideoTag[]

  @@map("tags")
}

model VideoTag {
  videoId String @map("video_id") @db.Uuid
  tagId   String @map("tag_id") @db.Uuid
  tag     Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)
  video   Video  @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@id([videoId, tagId])
  @@index([tagId])
  @@map("video_tags")
}

model Subscription {
  id           String   @id @default(uuid()) @db.Uuid
  subscriberId String   @map("subscriber_id") @db.Uuid
  creatorId    String   @map("creator_id") @db.Uuid
  createdAt    DateTime @default(now()) @map("created_at")
  creator      User     @relation("Creator", fields: [creatorId], references: [id], onDelete: Cascade)
  subscriber   User     @relation("Subscriber", fields: [subscriberId], references: [id], onDelete: Cascade)

  @@unique([subscriberId, creatorId])
  @@index([creatorId])
  @@index([subscriberId])
  @@map("subscriptions")
}

model Notification {
  id        String           @id @default(uuid()) @db.Uuid
  userId    String           @map("user_id") @db.Uuid
  type      NotificationType
  title     String           @db.VarChar(200)
  message   String?
  linkUrl   String?          @map("link_url")
  isRead    Boolean          @default(false) @map("is_read")
  readAt    DateTime?        @map("read_at")
  createdAt DateTime         @default(now()) @map("created_at")
  user      User             @relation("NotificationRecipient", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt(sort: Desc)])
  @@map("notifications")
}

model Account {
  id                String  @id @default(uuid()) @db.Uuid
  userId            String  @map("user_id") @db.Uuid
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refreshToken      String? @map("refresh_token")
  accessToken       String? @map("access_token")
  expiresAt         Int?    @map("expires_at")
  tokenType         String? @map("token_type")
  scope             String?
  idToken           String? @map("id_token")
  sessionState      String? @map("session_state")
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid()) @db.Uuid
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id") @db.Uuid
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  token   String   @unique
  expires DateTime
  email   String
  id      String   @id @default(uuid()) @db.Uuid

  @@unique([email, token])
  @@map("verification_tokens")
}

model PasswordResetToken {
  id      String   @id @default(uuid()) @db.Uuid
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
  @@map("password_reset_tokens")
}

model Model {
  id          String       @id @default(uuid()) @db.Uuid
  stageName   String       @map("stage_name") @db.VarChar(100)
  slug        String       @unique @db.VarChar(100)
  avatarUrl   String?      @map("avatar_url")
  bio         String?
  gender      ModelGender?
  ethnicity   String?      @db.VarChar(50)
  birthDate   DateTime?    @map("birth_date") @db.Date
  videoCount  Int          @default(0) @map("video_count")
  viewsCount  Int          @default(0) @map("views_count")
  isVerified  Boolean      @default(false) @map("is_verified")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  userId      String?      @unique @map("user_id") @db.Uuid
  user        User?        @relation(fields: [userId], references: [id])
  videoModels VideoModel[]

  @@index([slug])
  @@index([viewsCount(sort: Desc)])
  @@index([stageName])
  @@map("models")
}

model Category {
  id           String          @id @default(uuid()) @db.Uuid
  name         String          @unique @db.VarChar(50)
  slug         String          @unique @db.VarChar(50)
  thumbnailUrl String?         @map("thumbnail_url")
  description  String?
  videoCount   Int             @default(0) @map("video_count")
  viewsCount   Int             @default(0) @map("views_count")
  isActive     Boolean         @default(true) @map("is_active")
  sortOrder    Int             @default(0) @map("sort_order")
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")
  videos       VideoCategory[]

  @@index([slug])
  @@index([viewsCount(sort: Desc)])
  @@index([sortOrder])
  @@map("categories")
}

model VideoModel {
  videoId    String  @map("video_id") @db.Uuid
  modelId    String  @map("model_id") @db.Uuid
  isFeatured Boolean @default(false) @map("is_featured")
  model      Model   @relation(fields: [modelId], references: [id], onDelete: Cascade)
  video      Video   @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@id([videoId, modelId])
  @@index([modelId])
  @@map("video_models")
}

model VideoCategory {
  videoId    String   @map("video_id") @db.Uuid
  categoryId String   @map("category_id") @db.Uuid
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  video      Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@id([videoId, categoryId])
  @@index([categoryId])
  @@map("video_categories")
}

enum UserRole {
  USER
  CREATOR
  ADMIN

  @@map("user_role")
}

enum VideoStatus {
  PENDING
  PROCESSING
  PUBLISHED
  FAILED

  @@map("video_status")
}

enum ReportStatus {
  PENDING
  REVIEWED
  ACTIONED
  DISMISSED

  @@map("report_status")
}

enum NotificationType {
  NEW_VIDEO
  NEW_SUBSCRIBER
  VIDEO_COMMENT
  SYSTEM

  @@map("notification_type")
}

enum ModelGender {
  MALE
  FEMALE
  TRANS_MALE
  TRANS_FEMALE
  NON_BINARY

  @@map("model_gender")
}

enum VideoOrientation {
  STRAIGHT
  GAY
  LESBIAN
  TRANS

  @@map("video_orientation")
}
